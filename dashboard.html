<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Dashboard - AI Chat Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem 0;
        }

        .logo {
            text-align: center;
            margin-bottom: 2rem;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin: 0.5rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateX(5px);
        }

        .nav-icon {
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }

        .main-content {
            padding: 2rem;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            font-size: 2rem;
            font-weight: 600;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }

        .stat-title {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-value {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .stat-change {
            color: #4ade80;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .table-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .search-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: white;
            width: 200px;
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            color: white;
        }

        .type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .type-chat {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .type-exercise {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }

        .type-literature {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .type-question {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .sender-user {
            color: #4ade80;
            font-weight: 500;
        }

        .sender-ai {
            color: #60a5fa;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 2rem;
            font-size: 1.1rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .message-content {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .filter-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="sidebar">
            <div class="logo">üî• Firebase Dashboard</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-tab="overview">
                        <span class="nav-icon">üìä</span>
                        T·ªïng quan
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="messages">
                        <span class="nav-icon">üí¨</span>
                        T·∫•t c·∫£ tin nh·∫Øn
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="analytics">
                        <span class="nav-icon">üìà</span>
                        Th·ªëng k√™ chi ti·∫øt
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="settings">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        C√†i ƒë·∫∑t
                    </a>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="header">
                    <h1>T·ªïng quan h·ªá th·ªëng</h1>
                    <button class="refresh-btn" onclick="refreshData()">üîÑ L√†m m·ªõi</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card fade-in">
                        <div class="stat-header">
                            <div class="stat-icon">üí¨</div>
                            <div class="stat-title">T·ªïng tin nh·∫Øn</div>
                        </div>
                        <div class="stat-value" id="totalMessages">-</div>
                        <div class="stat-change">+12% t·ª´ h√¥m qua</div>
                    </div>
                    <div class="stat-card fade-in">
                        <div class="stat-header">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-title">Ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông</div>
                        </div>
                        <div class="stat-value" id="activeUsers">-</div>
                        <div class="stat-change">+5% t·ª´ h√¥m qua</div>
                    </div>
                    <div class="stat-card fade-in">
                        <div class="stat-header">
                            <div class="stat-icon">üìö</div>
                            <div class="stat-title">B√†i t·∫≠p ƒë√£ t·∫°o</div>
                        </div>
                        <div class="stat-value" id="totalExercises">-</div>
                        <div class="stat-change">+8% t·ª´ h√¥m qua</div>
                    </div>
                    <div class="stat-card fade-in">
                        <div class="stat-header">
                            <div class="stat-icon">üìñ</div>
                            <div class="stat-title">Ph√¢n t√≠ch vƒÉn h·ªçc</div>
                        </div>
                        <div class="stat-value" id="totalLiterature">-</div>
                        <div class="stat-change">+15% t·ª´ h√¥m qua</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Ho·∫°t ƒë·ªông theo th·ªùi gian</div>
                        <canvas id="activityChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Ph√¢n b·ªë lo·∫°i n·ªôi dung</div>
                        <canvas id="contentChart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- All Messages Tab -->
            <div id="messages" class="tab-content">
                <div class="header">
                    <h1>T·∫•t c·∫£ tin nh·∫Øn</h1>
                    <button class="refresh-btn" onclick="loadAllMessages()">üîÑ L√†m m·ªõi</button>
                </div>
                
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">Tin nh·∫Øn t·ª´ t·∫•t c·∫£ ngu·ªìn</div>
                        <input type="text" class="search-box" placeholder="T√¨m ki·∫øm tin nh·∫Øn..." id="messageSearch">
                    </div>
                    
                    <div class="filter-tabs">
                        <div class="filter-btn active" data-filter="all">T·∫•t c·∫£</div>
                        <div class="filter-btn" data-filter="chat">üí¨ Chat</div>
                        <div class="filter-btn" data-filter="exercise">üìö B√†i t·∫≠p</div>
                        <div class="filter-btn" data-filter="literature">üìñ VƒÉn h·ªçc</div>
                        <div class="filter-btn" data-filter="user">üë§ T·ª´ ng∆∞·ªùi d√πng</div>
                        <div class="filter-btn" data-filter="ai">ü§ñ T·ª´ AI</div>
                    </div>
                    
                    <div id="messageTableContainer">
                        <div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="header">
                    <h1>Th·ªëng k√™ chi ti·∫øt</h1>
                    <button class="refresh-btn" onclick="loadAnalytics()">üîÑ L√†m m·ªõi</button>
                </div>
                <div id="analyticsContent">
                    <div class="loading">ƒêang t·∫£i th·ªëng k√™...</div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="header">
                    <h1>C√†i ƒë·∫∑t h·ªá th·ªëng</h1>
                </div>
                <div class="stat-card">
                    <h3 style="color: white; margin-bottom: 1rem;">C·∫•u h√¨nh Firebase</h3>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 0.5rem;"><strong>Project ID:</strong> <span id="projectId">-</span></p>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 0.5rem;"><strong>Khu v·ª±c:</strong> asia-southeast1</p>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem;"><strong>Tr·∫°ng th√°i:</strong> <span class="type-badge type-chat">Ho·∫°t ƒë·ªông</span></p>
                    
                    <h3 style="color: white; margin: 2rem 0 1rem 0;">Thao t√°c b·∫£o tr√¨</h3>
                    <button class="refresh-btn" onclick="cleanupExpiredData()" style="margin-right: 1rem;">üßπ D·ªçn d·∫πp d·ªØ li·ªáu h·∫øt h·∫°n</button>
                    <button class="refresh-btn" onclick="exportData()">üì§ Export d·ªØ li·ªáu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCWGsu7u4b1ZIrmlU6uwhcuoOYaAGw2ypU",
            authDomain: "ai-chat-app-6e69c.firebaseapp.com",
            projectId: "ai-chat-app-6e69c",
            storageBucket: "ai-chat-app-6e69c.firebasestorage.app",
            messagingSenderId: "870009360725",
            appId: "1:870009360725:web:92b9717bfab381a3e95fdc"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let activityChart, contentChart;
        let allMessages = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            setupNavigation();
            setupFilters();
            loadOverviewData();
            setupCharts();
            document.getElementById('projectId').textContent = firebaseConfig.projectId;
        });

        // Navigation setup
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                    
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // Filter setup
        function setupFilters() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    filterMessages(filter);
                    
                    filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Search setup
            const searchInput = document.getElementById('messageSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    searchMessages(this.value);
                });
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            switch(tabName) {
                case 'messages':
                    loadAllMessages();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
            }
        }

        // Load overview data
        async function loadOverviewData() {
            try {
                const [chats, exercises, literature, questions] = await Promise.all([
                    db.collection('chatSessions').get(),
                    db.collection('exerciseSessions').get(),
                    db.collection('literatureSessions').get(),
                    db.collection('questions').get()
                ]);

                // Count unique users
                const uniqueUsers = new Set();
                chats.docs.forEach(doc => uniqueUsers.add(doc.data().ipHash));
                exercises.docs.forEach(doc => uniqueUsers.add(doc.data().ipHash));
                literature.docs.forEach(doc => uniqueUsers.add(doc.data().ipHash));

                // Calculate totals
                const totalMessages = chats.size + exercises.size + literature.size;
                const totalExercises = Math.floor(exercises.size / 2);
                const totalLiterature = Math.floor(literature.size / 2);

                // Update stats
                document.getElementById('totalMessages').textContent = totalMessages;
                document.getElementById('activeUsers').textContent = uniqueUsers.size;
                document.getElementById('totalExercises').textContent = totalExercises;
                document.getElementById('totalLiterature').textContent = totalLiterature;

                // Update charts
                updateActivityChart([chats.size, totalExercises, totalLiterature]);
                updateContentChart([chats.size, totalExercises, totalLiterature, questions.size]);

            } catch (error) {
                console.error('Error loading overview data:', error);
            }
        }

        // Load all messages from all collections
        async function loadAllMessages() {
            try {
                const container = document.getElementById('messageTableContainer');
                container.innerHTML = '<div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>';

                const [chats, exercises, literature, questions] = await Promise.all([
                    db.collection('chatSessions').orderBy('createdAt', 'desc').limit(100).get(),
                    db.collection('exerciseSessions').orderBy('createdAt', 'desc').limit(100).get(),
                    db.collection('literatureSessions').orderBy('createdAt', 'desc').limit(100).get(),
                    db.collection('questions').orderBy('timestamp', 'desc').limit(50).get()
                ]);

                // Combine all messages
                allMessages = [];

                // Add chat messages
                chats.docs.forEach(doc => {
                    const data = doc.data();
                    allMessages.push({
                        type: 'chat',
                        sender: data.sender,
                        content: data.content,
                        ipHash: data.ipHash,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                        isExpired: data.expiresAt && data.expiresAt.toDate() < new Date()
                    });
                });

                // Add exercise messages
                exercises.docs.forEach(doc => {
                    const data = doc.data();
                    allMessages.push({
                        type: 'exercise',
                        sender: data.sender,
                        content: data.content,
                        ipHash: data.ipHash,
                        subject: data.subject,
                        grade: data.grade,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                        isExpired: data.expiresAt && data.expiresAt.toDate() < new Date()
                    });
                });

                // Add literature messages
                literature.docs.forEach(doc => {
                    const data = doc.data();
                    allMessages.push({
                        type: 'literature',
                        sender: data.sender,
                        content: data.content,
                        ipHash: data.ipHash,
                        genre: data.genre,
                        author: data.author,
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(),
                        isExpired: data.expiresAt && data.expiresAt.toDate() < new Date()
                    });
                });

                // Add questions (tracking data)
                questions.docs.forEach(doc => {
                    const data = doc.data();
                    let questionType = 'chat';
                    
                    if (data.question && data.question.includes('[LITERATURE]')) {
                        questionType = 'literature';
                    } else if (data.question && data.question.includes('[EXERCISE]')) {
                        questionType = 'exercise';
                    }

                    allMessages.push({
                        type: 'question',
                        sender: 'tracking',
                        content: data.question ? data.question.replace('[LITERATURE]', '').replace('[EXERCISE]', '').trim() : '',
                        ipHash: data.userIP,
                        questionType: questionType,
                        createdAt: data.timestamp ? data.timestamp.toDate() : new Date(),
                        isExpired: false
                    });
                });

                // Sort by date (newest first)
                allMessages.sort((a, b) => b.createdAt - a.createdAt);

                // Display all messages
                displayMessages(allMessages);

            } catch (error) {
                console.error('Error loading all messages:', error);
                document.getElementById('messageTableContainer').innerHTML = 
                    '<div class="loading">‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            }
        }

        // Display messages in table
        function displayMessages(messages) {
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Th·ªùi gian</th>
                            <th>Lo·∫°i</th>
                            <th>Ng∆∞·ªùi g·ª≠i</th>
                            <th>N·ªôi dung</th>
                            <th>Th√¥ng tin th√™m</th>
                            <th>IP Hash</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            messages.forEach(message => {
                const typeClass = `type-${message.type}`;
                let typeText = '';
                let extraInfo = '';
                let senderText = '';

                switch(message.type) {
                    case 'chat':
                        typeText = 'üí¨ Chat';
                        break;
                    case 'exercise':
                        typeText = 'üìö B√†i t·∫≠p';
                        extraInfo = `${message.subject || ''} - L·ªõp ${message.grade || ''}`;
                        break;
                    case 'literature':
                        typeText = 'üìñ VƒÉn h·ªçc';
                        extraInfo = `${message.genre || ''} - ${message.author || ''}`;
                        break;
                    case 'question':
                        typeText = '‚ùì Theo d√µi';
                        extraInfo = `Ngu·ªìn: ${message.questionType}`;
                        break;
                }

                switch(message.sender) {
                    case 'user':
                        senderText = '<span class="sender-user">üë§ User</span>';
                        break;
                    case 'ai':
                        senderText = '<span class="sender-ai">ü§ñ AI</span>';
                        break;
                    case 'tracking':
                        senderText = '<span style="color: #f59e0b;">üìä Tracking</span>';
                        break;
                }

                tableHTML += `
                    <tr data-type="${message.type}" data-sender="${message.sender}">
                        <td>${message.createdAt.toLocaleString('vi-VN')}</td>
                        <td><span class="type-badge ${typeClass}">${typeText}</span></td>
                        <td>${senderText}</td>
                        <td class="message-content">${message.content ? message.content.substring(0, 150) : 'N/A'}${message.content && message.content.length > 150 ? '...' : ''}</td>
                        <td>${extraInfo}</td>
                        <td>${message.ipHash ? (typeof message.ipHash === 'string' ? message.ipHash.substring(0, 8) + '...' : message.ipHash) : 'N/A'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('messageTableContainer').innerHTML = tableHTML;
        }

        // Filter messages
        function filterMessages(filter) {
            const rows = document.querySelectorAll('#messageTableContainer tbody tr');
            
            rows.forEach(row => {
                const type = row.getAttribute('data-type');
                const sender = row.getAttribute('data-sender');
                let show = false;

                switch(filter) {
                    case 'all':
                        show = true;
                        break;
                    case 'chat':
                        show = type === 'chat';
                        break;
                    case 'exercise':
                        show = type === 'exercise';
                        break;
                    case 'literature':
                        show = type === 'literature';
                        break;
                    case 'user':
                        show = sender === 'user';
                        break;
                    case 'ai':
                        show = sender === 'ai';
                        break;
                }

                row.style.display = show ? '' : 'none';
            });
        }

        // Search messages
        function searchMessages(searchTerm) {
            const rows = document.querySelectorAll('#messageTableContainer tbody tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        // Setup charts
        function setupCharts() {
            // Activity chart
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'line',
               data: {
                   labels: ['Chat', 'B√†i t·∫≠p', 'VƒÉn h·ªçc', 'C√¢u h·ªèi', 'Ph·∫£n h·ªìi', 'T∆∞∆°ng t√°c'],
                   datasets: [{
                       label: 'Ho·∫°t ƒë·ªông',
                       data: [0, 0, 0, 0, 0, 0],
                       borderColor: 'rgba(74, 222, 128, 1)',
                       backgroundColor: 'rgba(74, 222, 128, 0.1)',
                       borderWidth: 3,
                       fill: true,
                       tension: 0.4
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: {
                       legend: {
                           display: false
                       }
                   },
                   scales: {
                       y: {
                           beginAtZero: true,
                           ticks: {
                               color: 'rgba(255, 255, 255, 0.7)'
                           },
                           grid: {
                               color: 'rgba(255, 255, 255, 0.1)'
                           }
                       },
                       x: {
                           ticks: {
                               color: 'rgba(255, 255, 255, 0.7)'
                           },
                           grid: {
                               color: 'rgba(255, 255, 255, 0.1)'
                           }
                       }
                   }
               }
           });

           // Content distribution chart
           const contentCtx = document.getElementById('contentChart').getContext('2d');
           contentChart = new Chart(contentCtx, {
               type: 'doughnut',
               data: {
                   labels: ['Chat', 'B√†i t·∫≠p', 'VƒÉn h·ªçc', 'C√¢u h·ªèi'],
                   datasets: [{
                       data: [0, 0, 0, 0],
                       backgroundColor: [
                           'rgba(74, 222, 128, 0.8)',
                           'rgba(96, 165, 250, 0.8)',
                           'rgba(245, 158, 11, 0.8)',
                           'rgba(239, 68, 68, 0.8)'
                       ],
                       borderColor: [
                           'rgba(74, 222, 128, 1)',
                           'rgba(96, 165, 250, 1)',
                           'rgba(245, 158, 11, 1)',
                           'rgba(239, 68, 68, 1)'
                       ],
                       borderWidth: 2
                   }]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: {
                       legend: {
                           position: 'bottom',
                           labels: {
                               color: 'rgba(255, 255, 255, 0.8)',
                               padding: 20,
                               usePointStyle: true
                           }
                       }
                   }
               }
           });
           
       }

       // Update activity chart
       function updateActivityChart(data) {
           if (activityChart) {
               const [chats, exercises, literature] = data;
               const chartData = [chats, exercises, literature, chats * 0.8, exercises * 1.2, literature * 0.9];
               activityChart.data.datasets[0].data = chartData;
               activityChart.update();
           }
       }

       // Update content chart
       function updateContentChart(data) {
           if (contentChart) {
               contentChart.data.datasets[0].data = data;
               contentChart.update();
           }
       }

       // Load analytics
       async function loadAnalytics() {
           try {
               const analyticsContent = document.getElementById('analyticsContent');
               analyticsContent.innerHTML = '<div class="loading">ƒêang t·∫£i th·ªëng k√™...</div>';

               // Get data from all collections
               const [chats, exercises, literature, questions] = await Promise.all([
                   db.collection('chatSessions').get(),
                   db.collection('exerciseSessions').get(),
                   db.collection('literatureSessions').get(),
                   db.collection('questions').get()
               ]);

               // Calculate detailed analytics
               const analytics = {
                   totalSessions: chats.size + exercises.size + literature.size,
                   totalQuestions: questions.size,
                   avgSessionLength: 0,
                   topSubjects: {},
                   topGenres: {},
                   hourlyDistribution: new Array(24).fill(0),
                   dailyDistribution: new Array(7).fill(0)
               };

               // Process exercises for subject analysis
               exercises.docs.forEach(doc => {
                   const data = doc.data();
                   if (data.subject) {
                       analytics.topSubjects[data.subject] = (analytics.topSubjects[data.subject] || 0) + 1;
                   }
                   if (data.createdAt) {
                       const hour = data.createdAt.toDate().getHours();
                       const day = data.createdAt.toDate().getDay();
                       analytics.hourlyDistribution[hour]++;
                       analytics.dailyDistribution[day]++;
                   }
               });

               // Process literature for genre analysis
               literature.docs.forEach(doc => {
                   const data = doc.data();
                   if (data.genre) {
                       analytics.topGenres[data.genre] = (analytics.topGenres[data.genre] || 0) + 1;
                   }
                   if (data.createdAt) {
                       const hour = data.createdAt.toDate().getHours();
                       const day = data.createdAt.toDate().getDay();
                       analytics.hourlyDistribution[hour]++;
                       analytics.dailyDistribution[day]++;
                   }
               });

               // Process chats for time analysis
               chats.docs.forEach(doc => {
                   const data = doc.data();
                   if (data.createdAt) {
                       const hour = data.createdAt.toDate().getHours();
                       const day = data.createdAt.toDate().getDay();
                       analytics.hourlyDistribution[hour]++;
                       analytics.dailyDistribution[day]++;
                   }
               });

               // Display analytics
               displayAnalytics(analytics);

           } catch (error) {
               console.error('Error loading analytics:', error);
               document.getElementById('analyticsContent').innerHTML = 
                   '<div class="loading">‚ùå L·ªói khi t·∫£i th·ªëng k√™</div>';
           }
       }

       // Display analytics
       function displayAnalytics(analytics) {
           const topSubjects = Object.entries(analytics.topSubjects)
               .sort((a, b) => b[1] - a[1])
               .slice(0, 5);
           
           const topGenres = Object.entries(analytics.topGenres)
               .sort((a, b) => b[1] - a[1])
               .slice(0, 5);

           const dayNames = ['Ch·ªß Nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];

           let analyticsHTML = `
               <div class="stats-grid">
                   <div class="stat-card fade-in">
                       <div class="stat-header">
                           <div class="stat-icon">üìä</div>
                           <div class="stat-title">T·ªïng phi√™n l√†m vi·ªác</div>
                       </div>
                       <div class="stat-value">${analytics.totalSessions}</div>
                       <div class="stat-change">T·∫•t c·∫£ lo·∫°i h√¨nh</div>
                   </div>
                   <div class="stat-card fade-in">
                       <div class="stat-header">
                           <div class="stat-icon">‚ùì</div>
                           <div class="stat-title">T·ªïng c√¢u h·ªèi tracking</div>
                       </div>
                       <div class="stat-value">${analytics.totalQuestions}</div>
                       <div class="stat-change">T·ª´ t·∫•t c·∫£ ngu·ªìn</div>
                   </div>
               </div>

               <div class="charts-grid" style="grid-template-columns: 1fr 1fr; margin: 2rem 0;">
                   <div class="chart-card">
                       <div class="chart-title">Top 5 m√¥n h·ªçc ƒë∆∞·ª£c h·ªèi nhi·ªÅu nh·∫•t</div>
                       <div style="padding: 1rem 0;">
                           ${topSubjects.map(([subject, count]) => `
                               <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.5rem 0; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                   <span style="color: white;">${subject}</span>
                                   <span class="type-badge type-exercise">${count}</span>
                               </div>
                           `).join('')}
                       </div>
                   </div>
                   
                   <div class="chart-card">
                       <div class="chart-title">Top 5 th·ªÉ lo·∫°i vƒÉn h·ªçc</div>
                       <div style="padding: 1rem 0;">
                           ${topGenres.map(([genre, count]) => `
                               <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.5rem 0; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                   <span style="color: white;">${genre}</span>
                                   <span class="type-badge type-literature">${count}</span>
                               </div>
                           `).join('')}
                       </div>
                   </div>
               </div>

               <div class="chart-card" style="margin-top: 1.5rem;">
                   <div class="chart-title">Ph√¢n b·ªë ho·∫°t ƒë·ªông theo gi·ªù trong ng√†y</div>
                   <canvas id="hourlyChart" width="800" height="300"></canvas>
               </div>

               <div class="chart-card" style="margin-top: 1.5rem;">
                   <div class="chart-title">Ph√¢n b·ªë ho·∫°t ƒë·ªông theo ng√†y trong tu·∫ßn</div>
                   <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1rem; padding: 1rem 0;">
                       ${analytics.dailyDistribution.map((count, index) => `
                           <div style="text-align: center;">
                               <div style="color: white; font-size: 0.9rem; margin-bottom: 0.5rem;">${dayNames[index]}</div>
                               <div style="background: rgba(74, 222, 128, 0.2); height: ${Math.max(20, count * 3)}px; border-radius: 4px; display: flex; align-items: end; justify-content: center; color: #4ade80; font-weight: bold; font-size: 0.8rem;">
                                   ${count}
                               </div>
                           </div>
                       `).join('')}
                   </div>
               </div>
           `;

           document.getElementById('analyticsContent').innerHTML = analyticsHTML;

           // Create hourly chart
           setTimeout(() => {
               const hourlyCtx = document.getElementById('hourlyChart');
               if (hourlyCtx) {
                   new Chart(hourlyCtx.getContext('2d'), {
                       type: 'bar',
                       data: {
                           labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                           datasets: [{
                               label: 'Ho·∫°t ƒë·ªông',
                               data: analytics.hourlyDistribution,
                               backgroundColor: 'rgba(74, 222, 128, 0.6)',
                               borderColor: 'rgba(74, 222, 128, 1)',
                               borderWidth: 1
                           }]
                       },
                       options: {
                           responsive: true,
                           maintainAspectRatio: false,
                           plugins: {
                               legend: {
                                   display: false
                               }
                           },
                           scales: {
                               y: {
                                   beginAtZero: true,
                                   ticks: {
                                       color: 'rgba(255, 255, 255, 0.7)'
                                   },
                                   grid: {
                                       color: 'rgba(255, 255, 255, 0.1)'
                                   }
                               },
                               x: {
                                   ticks: {
                                       color: 'rgba(255, 255, 255, 0.7)'
                                   },
                                   grid: {
                                       color: 'rgba(255, 255, 255, 0.1)'
                                   }
                               }
                           }
                       }
                   });
               }
           }, 100);
       }

       // Refresh all data
       function refreshData() {
           loadOverviewData();
           if (document.getElementById('messages').classList.contains('active')) {
               loadAllMessages();
           }
           if (document.getElementById('analytics').classList.contains('active')) {
               loadAnalytics();
           }
       }

       // Cleanup expired data
       async function cleanupExpiredData() {
           if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ h·∫øt h·∫°n?')) {
               return;
           }

           try {
               const now = new Date();
               const collections = ['chatSessions', 'exerciseSessions', 'literatureSessions'];
               let deletedCount = 0;

               for (const collectionName of collections) {
                   const expiredDocs = await db.collection(collectionName)
                       .where('expiresAt', '<=', now)
                       .get();
                   
                   const batch = db.batch();
                   expiredDocs.docs.forEach(doc => {
                       batch.delete(doc.ref);
                       deletedCount++;
                   });
                   
                   if (expiredDocs.docs.length > 0) {
                       await batch.commit();
                   }
               }

               alert(`ƒê√£ x√≥a ${deletedCount} b·∫£n ghi h·∫øt h·∫°n th√†nh c√¥ng!`);
               refreshData();

           } catch (error) {
               console.error('Error cleaning up data:', error);
               alert('C√≥ l·ªói khi d·ªçn d·∫πp d·ªØ li·ªáu!');
           }
       }

       // Export data
       async function exportData() {
           try {
               const [chats, exercises, literature, questions] = await Promise.all([
                   db.collection('chatSessions').get(),
                   db.collection('exerciseSessions').get(),
                   db.collection('literatureSessions').get(),
                   db.collection('questions').get()
               ]);

               const exportData = {
                   timestamp: new Date().toISOString(),
                   collections: {
                       chatSessions: chats.docs.map(doc => ({id: doc.id, ...doc.data()})),
                       exerciseSessions: exercises.docs.map(doc => ({id: doc.id, ...doc.data()})),
                       literatureSessions: literature.docs.map(doc => ({id: doc.id, ...doc.data()})),
                       questions: questions.docs.map(doc => ({id: doc.id, ...doc.data()}))
                   }
               };

               const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                   {type: 'application/json'});
               const url = URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = `firebase-export-${new Date().toISOString().split('T')[0]}.json`;
               document.body.appendChild(a);
               a.click();
               document.body.removeChild(a);
               URL.revokeObjectURL(url);

               alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c xu·∫•t th√†nh c√¥ng!');

           } catch (error) {
               console.error('Error exporting data:', error);
               alert('C√≥ l·ªói khi xu·∫•t d·ªØ li·ªáu!');
           }
       }

       // Real-time updates (optional)
       function setupRealTimeUpdates() {
           const collections = ['chatSessions', 'exerciseSessions', 'literatureSessions', 'questions'];
           
           collections.forEach(collectionName => {
               db.collection(collectionName).onSnapshot((snapshot) => {
                   if (!snapshot.metadata.fromCache) {
                       refreshData();
                   }
               });
           });
       }

       // Initialize real-time updates
       // setupRealTimeUpdates(); // Uncomment if you want real-time updates
   </script>
</body>
</html>